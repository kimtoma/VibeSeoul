<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vibe Seoul ‚Äî Feel K-Content Through Seoul</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0a0a0f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="description" content="Transform K-content into sensory Seoul experiences with AI-powered location mapping, artwork, and soundscapes.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=Noto+Sans+KR:wght@300;500;700&display=swap" rel="stylesheet">
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0a0a0f;
      --text: #f0f0f0;
      --text-dim: #888;
      --accent: #FFB800;
      --accent-glow: rgba(255,184,0,0.2);
      --radius: 20px;
      --transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    html, body {
      width: 100%; height: 100%;
      overflow: hidden;
      font-family: 'Outfit', 'Noto Sans KR', sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* ===== SCREENS ===== */
    .screen {
      position: fixed;
      inset: 0;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .screen.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* ===== ATMOSPHERIC ORBS (kimtoma.com style) ===== */
    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
      z-index: 0;
    }
    .orb-1 {
      width: 70vw; height: 70vw;
      top: -20%; left: -15%;
      background: radial-gradient(circle, rgba(255,184,0,0.12) 0%, transparent 65%);
      animation: drift1 22s ease-in-out infinite;
    }
    .orb-2 {
      width: 55vw; height: 55vw;
      bottom: -15%; right: -10%;
      background: radial-gradient(circle, rgba(167,139,250,0.1) 0%, transparent 65%);
      animation: drift2 28s ease-in-out infinite;
    }
    .orb-3 {
      width: 40vw; height: 40vw;
      top: 35%; right: 15%;
      background: radial-gradient(circle, rgba(0,212,255,0.07) 0%, transparent 65%);
      animation: drift3 18s ease-in-out 3s infinite;
    }
    @keyframes drift1 {
      0%,100% { transform: translate(0,0) scale(1); }
      25%  { transform: translate(4vw, 3vh) scale(1.08); }
      50%  { transform: translate(2vw, 7vh) scale(0.94); }
      75%  { transform: translate(-3vw, 2vh) scale(1.04); }
    }
    @keyframes drift2 {
      0%,100% { transform: translate(0,0) scale(1); }
      33%  { transform: translate(-4vw,-5vh) scale(1.1); }
      66%  { transform: translate(3vw,-2vh) scale(0.92); }
    }
    @keyframes drift3 {
      0%,100% { transform: translate(0,0) scale(1); opacity: 0.8; }
      50%  { transform: translate(-4vw, 5vh) scale(1.15); opacity: 1; }
    }

    /* ===== LANDING SCREEN ===== */
    #landingScreen { background: var(--bg); }

    .landing-header {
      position: absolute;
      top: 0; left: 0; right: 0;
      z-index: 10;
      padding: 28px 32px 0;
      display: flex;
      align-items: baseline;
      gap: 12px;
    }
    .logo {
      font-weight: 900;
      font-size: 1.4rem;
      letter-spacing: -0.03em;
    }
    .logo span { color: var(--accent); transition: color var(--transition); }
    .logo-sub {
      font-size: 0.7rem;
      color: var(--text-dim);
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    /* Cover flow container */
    .coverflow-wrap {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 5;
      perspective: 1200px;
    }

    .coverflow-stage {
      position: relative;
      width: 100%;
      height: 420px;
      display: flex;
      align-items: center;
      justify-content: center;
      transform-style: preserve-3d;
      cursor: grab;
    }
    .coverflow-stage:active { cursor: grabbing; }

    /* Individual poster */
    .poster {
      position: absolute;
      width: 200px;
      height: 300px;
      border-radius: 24px;
      overflow: hidden;
      cursor: pointer;
      transform-style: preserve-3d;
      transition: transform 0.55s cubic-bezier(0.4,0,0.2,1),
                  box-shadow 0.55s cubic-bezier(0.4,0,0.2,1),
                  opacity 0.55s;
      user-select: none;
      -webkit-user-drag: none;
    }

    .poster-inner {
      width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding: 20px 16px;
      position: relative;
    }

    .poster-emoji {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -62%);
      font-size: 4rem;
      filter: drop-shadow(0 8px 20px rgba(0,0,0,0.5));
      pointer-events: none;
    }

    .poster-genre {
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.5);
      margin-bottom: 6px;
    }
    .poster-title-ko {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 0.8rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 4px;
    }
    .poster-title {
      font-size: 1.05rem;
      font-weight: 700;
      text-align: center;
      line-height: 1.2;
      color: #fff;
    }

    /* Floating animation per poster ‚Äî staggered */
    .poster:nth-child(1) { animation: floatPoster 6.5s ease-in-out infinite; }
    .poster:nth-child(2) { animation: floatPoster 7.2s ease-in-out 0.8s infinite; }
    .poster:nth-child(3) { animation: floatPoster 6.0s ease-in-out 1.6s infinite; }
    .poster:nth-child(4) { animation: floatPoster 7.8s ease-in-out 0.4s infinite; }
    .poster:nth-child(5) { animation: floatPoster 6.8s ease-in-out 1.2s infinite; }
    .poster:nth-child(6) { animation: floatPoster 7.5s ease-in-out 2.0s infinite; }
    .poster:nth-child(7) { animation: floatPoster 6.2s ease-in-out 0.6s infinite; }

    @keyframes floatPoster {
      0%,100% { transform: var(--poster-transform) translateY(0px); }
      50%      { transform: var(--poster-transform) translateY(-12px); }
    }

    /* Cover flow tap hint */
    .tap-hint {
      position: absolute;
      bottom: 36px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.72rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text-dim);
      z-index: 10;
      animation: pulse 2.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%,100% { opacity: 0.4; }
      50% { opacity: 1; }
    }

    /* Nav dots */
    .nav-dots {
      display: flex;
      gap: 8px;
      margin-top: 28px;
      z-index: 10;
    }
    .nav-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transition: all 0.3s;
      cursor: pointer;
    }
    .nav-dot.active {
      width: 20px;
      border-radius: 3px;
      background: var(--accent);
    }

    /* ===== LOADING SCREEN ===== */
    #loadingScreen {
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }
    .load-poster-preview {
      width: 120px; height: 180px;
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      animation: loadPulse 1.5s ease-in-out infinite;
    }
    @keyframes loadPulse {
      0%,100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.05); opacity: 1; }
    }
    .loading-text {
      font-size: 1.1rem;
      color: var(--text-dim);
      letter-spacing: 0.05em;
    }
    .loading-text span { color: var(--accent); font-weight: 700; }
    .loading-dots {
      display: flex; gap: 6px;
    }
    .loading-dots span {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: dotBounce 1.2s ease-in-out infinite;
    }
    .loading-dots span:nth-child(2) { animation-delay: 0.15s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.3s; }
    @keyframes dotBounce {
      0%,80%,100% { transform: scale(0.6); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* ===== RESULT SCREEN ===== */
    #resultScreen { background: #000; }

    /* Map fills everything */
    #map {
      position: absolute;
      inset: 0;
      width: 100%; height: 100%;
      z-index: 0;
    }

    /* Top bar overlay */
    .result-topbar {
      position: absolute;
      top: 0; left: 0; right: 0;
      z-index: 20;
      padding: 20px 20px 0;
      display: flex;
      align-items: center;
      gap: 14px;
      background: linear-gradient(to bottom, rgba(10,10,15,0.85) 0%, transparent 100%);
      padding-bottom: 40px;
    }
    .back-btn {
      width: 42px; height: 42px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.15);
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .back-btn:hover { background: rgba(255,255,255,0.18); transform: scale(1.05); }

    .result-title-wrap { flex: 1; }
    .result-content-title {
      font-size: 1.1rem;
      font-weight: 700;
      line-height: 1.2;
    }
    .result-mood-label {
      font-size: 0.75rem;
      color: var(--accent);
      margin-top: 2px;
      transition: color var(--transition);
    }

    /* Bottom overlay panel */
    .spots-panel {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      z-index: 20;
      background: linear-gradient(to top, rgba(10,10,15,0.97) 60%, transparent 100%);
      padding: 0 0 24px;
    }

    /* Music player */
    .music-player {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 20px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .play-btn {
      width: 38px; height: 38px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: transform 0.2s, background var(--transition);
    }
    .play-btn:hover { transform: scale(1.08); }
    .play-btn svg { width: 16px; height: 16px; fill: #0a0a0f; }
    .music-info { flex: 1; min-width: 0; }
    .music-track {
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .music-artist {
      font-size: 0.7rem;
      color: var(--text-dim);
      margin-top: 2px;
    }
    .volume-slider {
      width: 72px;
      accent-color: var(--accent);
      flex-shrink: 0;
    }

    /* Location cards ‚Äî horizontal scroll */
    .cards-label {
      padding: 12px 20px 8px;
      font-size: 0.7rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-dim);
    }
    .cards-scroll {
      display: flex;
      gap: 12px;
      padding: 0 20px 4px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      scrollbar-width: none;
    }
    .cards-scroll::-webkit-scrollbar { display: none; }

    .location-card {
      flex-shrink: 0;
      width: 220px;
      background: rgba(255,255,255,0.07);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 14px;
      cursor: pointer;
      scroll-snap-align: start;
      transition: all 0.3s;
      animation: cardSlideIn 0.4s ease-out both;
    }
    .location-card:nth-child(1) { animation-delay: 0.05s; }
    .location-card:nth-child(2) { animation-delay: 0.12s; }
    .location-card:nth-child(3) { animation-delay: 0.19s; }
    .location-card:nth-child(4) { animation-delay: 0.26s; }
    .location-card:nth-child(5) { animation-delay: 0.33s; }
    @keyframes cardSlideIn {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .location-card:hover,
    .location-card.active {
      background: rgba(255,255,255,0.13);
      border-color: var(--accent);
      box-shadow: 0 0 24px var(--accent-glow);
    }

    .card-num-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .card-num {
      width: 22px; height: 22px;
      border-radius: 50%;
      background: var(--accent);
      color: #0a0a0f;
      font-size: 0.72rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background var(--transition);
    }
    .card-neighborhood {
      font-size: 0.68rem;
      color: var(--accent);
      letter-spacing: 0.05em;
      transition: color var(--transition);
    }
    .card-name-en {
      font-weight: 700;
      font-size: 0.95rem;
      line-height: 1.2;
    }
    .card-name-ko {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-top: 2px;
    }
    .card-reason {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
      line-height: 1.4;
      margin-top: 8px;
    }
    .card-image {
      width: 100%;
      aspect-ratio: 4/3;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
      background: rgba(255,255,255,0.04);
      position: relative;
    }
    .card-image img {
      width: 100%; height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.6s;
    }
    .card-image img.loaded { opacity: 1; }
    .skeleton {
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg,
        rgba(255,255,255,0.03) 25%,
        rgba(255,255,255,0.07) 50%,
        rgba(255,255,255,0.03) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton.hidden { display: none; }

    /* Error toast */
    .error-toast {
      position: fixed;
      bottom: 30px; left: 50%; transform: translateX(-50%);
      background: rgba(255,60,60,0.15);
      border: 1px solid rgba(255,60,60,0.3);
      backdrop-filter: blur(12px);
      padding: 12px 24px;
      border-radius: 40px;
      color: #ff6b6b;
      font-size: 0.85rem;
      z-index: 999;
      display: none;
    }
    .error-toast.active { display: block; }
  </style>
</head>
<body>

<!-- ===== LANDING SCREEN ===== -->
<div class="screen active" id="landingScreen">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>

  <header class="landing-header">
    <div class="logo">Vibe<span>Seoul</span></div>
    <div class="logo-sub">Feel K-Content</div>
  </header>

  <div class="coverflow-wrap">
    <div class="coverflow-stage" id="coverflowStage"></div>
    <div class="nav-dots" id="navDots"></div>
  </div>

  <div class="tap-hint">tap to explore Seoul</div>
</div>

<!-- ===== LOADING SCREEN ===== -->
<div class="screen" id="loadingScreen">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="load-poster-preview" id="loadPosterPreview"></div>
  <div class="loading-text">Vibing with <span>Seoul</span>...</div>
  <div class="loading-dots">
    <span></span><span></span><span></span>
  </div>
</div>

<!-- ===== RESULT SCREEN ===== -->
<div class="screen" id="resultScreen">
  <div id="map"></div>

  <div class="result-topbar">
    <button class="back-btn" id="backBtn">‚Üê</button>
    <div class="result-title-wrap">
      <div class="result-content-title" id="resultTitle"></div>
      <div class="result-mood-label" id="moodBanner"></div>
    </div>
  </div>

  <div class="spots-panel">
    <div class="music-player">
      <button class="play-btn" id="audioPlayBtn">
        <svg id="playIcon" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
        <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
      </button>
      <div class="music-info">
        <div class="music-track" id="audioMoodLabel">üéµ K-Content OST</div>
        <div class="music-artist" id="audioArtist">‚Äî</div>
      </div>
      <input type="range" class="volume-slider" id="audioVolume" min="0" max="100" value="30">
    </div>

    <div class="cards-label">Seoul Spots</div>
    <div class="cards-scroll" id="cardsPanel"></div>
  </div>
</div>

<!-- Error toast -->
<div class="error-toast" id="errorMsg">üòî Something went wrong. Try again.</div>

<script>
  // ===== K-CONTENT CATALOGUE =====
  const CONTENTS = [
    { query: 'Squid Game',                   titleKo: 'Ïò§ÏßïÏñ¥ Í≤åÏûÑ',    emoji: 'ü¶ë', genre: 'Thriller',        bg: 'linear-gradient(145deg,#1a0505,#3a0010)', accent: '#FF2D55' },
    { query: 'Goblin ÎèÑÍπ®ÎπÑ',                 titleKo: 'ÎèÑÍπ®ÎπÑ',         emoji: 'üëª', genre: 'Fantasy Romance', bg: 'linear-gradient(145deg,#080820,#1a0d35)', accent: '#A78BFA' },
    { query: 'BTS Dynamite',                 titleKo: 'BTS Îã§Ïù¥ÎÑàÎßàÏù¥Ìä∏', emoji: 'üéµ', genre: 'K-Pop',           bg: 'linear-gradient(145deg,#060e1f,#0a2040)', accent: '#00D4FF' },
    { query: 'K-Pop Demon Hunters',          titleKo: 'ÏºÄÏù¥Ìåù ÏïÖÎßàÌóåÌÑ∞', emoji: 'üòà', genre: 'Action',          bg: 'linear-gradient(145deg,#080f05,#102008)', accent: '#34D399' },
    { query: 'When Life Gives You Tangerines Í∑§Ïù¥ ÏùµÎäî ÏãúÏ†à', titleKo: 'Í∑§Ïù¥ ÏùµÎäî ÏãúÏ†à', emoji: 'üçä', genre: 'Drama', bg: 'linear-gradient(145deg,#1a0d00,#2d1800)', accent: '#FFB800' },
    { query: 'Parasite Í∏∞ÏÉùÏ∂©',               titleKo: 'Í∏∞ÏÉùÏ∂©',          emoji: 'üé¨', genre: 'Thriller',        bg: 'linear-gradient(145deg,#0a0a0a,#1c1c22)', accent: '#C0C0C0' },
    { query: 'Reply 1988 ÏùëÎãµÌïòÎùº 1988',       titleKo: 'ÏùëÎãµÌïòÎùº 1988',   emoji: 'üì∫', genre: 'Nostalgia',       bg: 'linear-gradient(145deg,#180814,#2a0f22)', accent: '#FF9ECD' },
  ];

  let activeIdx = Math.floor(CONTENTS.length / 2);
  let isDragging = false, dragStartX = 0, dragDeltaX = 0;

  // ===== BUILD COVER FLOW =====
  function buildCoverflow() {
    const stage = document.getElementById('coverflowStage');
    const dots  = document.getElementById('navDots');
    stage.innerHTML = '';
    dots.innerHTML  = '';

    CONTENTS.forEach((c, i) => {
      // Poster
      const el = document.createElement('div');
      el.className = 'poster';
      el.dataset.idx = i;
      el.innerHTML = `
        <div class="poster-inner" style="background:${c.bg};">
          <div class="poster-emoji">${c.emoji}</div>
          <div class="poster-genre">${c.genre}</div>
          <div class="poster-title-ko">${c.titleKo}</div>
          <div class="poster-title">${c.query.split(' ').slice(0,3).join(' ')}</div>
        </div>`;
      el.addEventListener('click', () => onPosterClick(i));
      stage.appendChild(el);

      // Dot
      const dot = document.createElement('div');
      dot.className = 'nav-dot';
      dot.addEventListener('click', () => setActive(i));
      dots.appendChild(dot);
    });

    // Drag / swipe
    stage.addEventListener('mousedown', e => { isDragging = true; dragStartX = e.clientX; });
    stage.addEventListener('mousemove', e => { if (isDragging) dragDeltaX = e.clientX - dragStartX; });
    stage.addEventListener('mouseup', finishDrag);
    stage.addEventListener('mouseleave', finishDrag);
    stage.addEventListener('touchstart', e => { isDragging = true; dragStartX = e.touches[0].clientX; }, { passive: true });
    stage.addEventListener('touchmove', e => { if (isDragging) dragDeltaX = e.touches[0].clientX - dragStartX; }, { passive: true });
    stage.addEventListener('touchend', finishDrag);

    setActive(activeIdx, false);
  }

  function finishDrag() {
    if (!isDragging) return;
    isDragging = false;
    if (dragDeltaX < -50 && activeIdx < CONTENTS.length - 1) setActive(activeIdx + 1);
    else if (dragDeltaX > 50 && activeIdx > 0) setActive(activeIdx - 1);
    dragDeltaX = 0;
  }

  function setActive(idx, animate = true) {
    activeIdx = idx;
    const posters = document.querySelectorAll('.poster');
    const dots    = document.querySelectorAll('.nav-dot');

    posters.forEach((el, i) => {
      const offset = i - idx;
      const abs    = Math.abs(offset);

      let scale   = Math.max(0.55, 1 - abs * 0.18);
      let rotateY = offset * 40;
      let tx      = offset * 160;
      let tz      = -abs * 120;
      let opacity = Math.max(0.25, 1 - abs * 0.28);
      let zIndex  = 10 - abs;

      const transform = `translateX(${tx}px) translateZ(${tz}px) rotateY(${rotateY}deg) scale(${scale})`;
      el.style.setProperty('--poster-transform', transform);
      el.style.transform = `${transform} translateY(0px)`;
      el.style.opacity   = opacity;
      el.style.zIndex    = zIndex;

      // Shadow glow on active
      const c = CONTENTS[i];
      el.style.boxShadow = abs === 0
        ? `0 30px 80px rgba(0,0,0,0.6), 0 0 60px ${c.accent}40`
        : `0 20px 50px rgba(0,0,0,0.4)`;
    });

    dots.forEach((d, i) => d.classList.toggle('active', i === idx));
  }

  function onPosterClick(i) {
    if (i !== activeIdx) { setActive(i); return; }
    doSearch(CONTENTS[i]);
  }

  // ===== MOOD / MAP CONFIG =====
  const MOOD_COLORS = {
    romantic:   { accent: '#FFB800', glow: 'rgba(255,184,0,0.2)',   emoji: 'üåô', label: 'Romantic Night Seoul' },
    tense:      { accent: '#FF2D55', glow: 'rgba(255,45,85,0.2)',   emoji: '‚ö°', label: 'Tense Urban Seoul' },
    bright:     { accent: '#00D4FF', glow: 'rgba(0,212,255,0.2)',   emoji: '‚ú®', label: 'Bright Retro Seoul' },
    melancholy: { accent: '#A78BFA', glow: 'rgba(167,139,250,0.2)', emoji: 'üåßÔ∏è', label: 'Melancholy Seoul' },
    energetic:  { accent: '#34D399', glow: 'rgba(52,211,153,0.2)',  emoji: 'üî•', label: 'Energetic Street Seoul' },
  };
  const MAP_STYLE = [
    { elementType: 'geometry',           stylers: [{ color: '#1d1d2b' }] },
    { elementType: 'labels.text.stroke', stylers: [{ color: '#1d1d2b' }] },
    { elementType: 'labels.text.fill',   stylers: [{ color: '#6b6b8a' }] },
    { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#2a2a3d' }] },
    { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e0e1a' }] },
    { featureType: 'poi',     stylers: [{ visibility: 'off' }] },
    { featureType: 'transit', stylers: [{ visibility: 'off' }] },
  ];

  let map, markers = [];

  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 37.5665, lng: 126.978 },
      zoom: 12,
      styles: MAP_STYLE,
      disableDefaultUI: true,
      zoomControl: false,
      gestureHandling: 'greedy',
    });
  }

  function applyMood(mood) {
    const m = MOOD_COLORS[mood] || MOOD_COLORS.romantic;
    document.documentElement.style.setProperty('--accent', m.accent);
    document.documentElement.style.setProperty('--accent-glow', m.glow);
    document.getElementById('moodBanner').textContent = `${m.emoji} ${m.label}`;
  }

  function clearMarkers() { markers.forEach(m => m.setMap(null)); markers = []; }

  function addMarkers(locations, mood) {
    clearMarkers();
    const bounds = new google.maps.LatLngBounds();
    const color  = (MOOD_COLORS[mood] || MOOD_COLORS.romantic).accent;

    locations.forEach((loc, i) => {
      const pos = { lat: loc.lat, lng: loc.lng };
      bounds.extend(pos);
      const marker = new google.maps.Marker({
        position: pos, map,
        label: { text: String(i + 1), color: '#0a0a0f', fontWeight: '700', fontSize: '11px' },
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: color, fillOpacity: 1,
          strokeColor: '#fff', strokeWeight: 2, scale: 14,
        },
      });
      marker.addListener('click', () => focusCard(i));
      markers.push(marker);
    });
    map.fitBounds(bounds, { padding: 60, bottom: 260 });
  }

  function focusCard(i) {
    document.querySelectorAll('.location-card').forEach(c => c.classList.remove('active'));
    const card = document.getElementById(`card-${i}`);
    card?.classList.add('active');
    card?.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
  }

  function buildCards(locations, mood) {
    const panel = document.getElementById('cardsPanel');
    panel.innerHTML = '';
    locations.forEach((loc, i) => {
      const card = document.createElement('div');
      card.className = 'location-card';
      card.id = `card-${i}`;
      card.innerHTML = `
        <div class="card-num-row">
          <div class="card-num">${i + 1}</div>
          <div class="card-neighborhood">${loc.neighborhood}</div>
        </div>
        <div class="card-name-en">${loc.nameEn}</div>
        <div class="card-name-ko">${loc.nameKo}</div>
        <div class="card-reason">${loc.reason}</div>
        <div class="card-image" id="img-container-${i}">
          <div class="skeleton" id="skeleton-${i}"></div>
          <img id="img-${i}" alt="${loc.nameEn}">
        </div>`;
      card.addEventListener('click', () => {
        document.querySelectorAll('.location-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        if (map) { map.panTo({ lat: loc.lat, lng: loc.lng }); map.setZoom(15); }
      });
      panel.appendChild(card);
    });
  }

  // ===== GEMINI: LOCATIONS =====
  async function getLocations(query) {
    const prompt = `You are a Seoul tourism expert who deeply understands K-content culture and Korean wave.

Given this K-content: "${query}"

Analyze the emotional mood and atmosphere of this content, then recommend 5 real Seoul locations where a tourist could FEEL the same atmosphere. Choose actual, visitable places (cafes, streets, neighborhoods, parks, landmarks).

Respond ONLY in this exact JSON format, no markdown:
{
  "contentTitle": "the content name",
  "mood": "one of: romantic, tense, bright, melancholy, energetic",
  "moodDescription": "2 sentence description of the content's atmosphere",
  "locations": [
    {
      "nameKo": "Korean name",
      "nameEn": "English name",
      "neighborhood": "district/area",
      "lat": 37.xxx,
      "lng": 126.xxx,
      "reason": "1 sentence why this matches the mood",
      "imagePrompt": "A cinematic photorealistic artwork of [this specific Seoul location] at [time of day], [mood-specific atmosphere]. Atmospheric lighting, 4K quality, Korean urban aesthetic."
    }
  ],
  "ost": {
    "title": "Most iconic OST or theme song title",
    "artist": "Artist or composer name",
    "searchQuery": "YouTube search query (e.g. 'Way Back Then Squid Game OST official')",
    "startSeconds": 30
  }
}`;

    const res = await fetch('/api/gemini', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'gemini-2.5-flash',
        body: {
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.8, topP: 0.95, responseMimeType: 'application/json' },
        },
      }),
    });
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) throw new Error('No response from Gemini');
    return JSON.parse(text);
  }

  // ===== GEMINI: IMAGE =====
  async function generateImage(imagePrompt, index) {
    try {
      const res = await fetch('/api/gemini', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'gemini-3.1-flash-image-preview',
          body: {
            contents: [{ parts: [{ text: imagePrompt }] }],
            generationConfig: { responseModalities: ['TEXT', 'IMAGE'] },
          },
        }),
      });
      const data = await res.json();
      const parts = data.candidates?.[0]?.content?.parts || [];
      const imgPart = parts.find(p => p.inlineData);
      if (imgPart) {
        const img = document.getElementById(`img-${index}`);
        img.src = `data:${imgPart.inlineData.mimeType};base64,${imgPart.inlineData.data}`;
        img.onload = () => {
          img.classList.add('loaded');
          document.getElementById(`skeleton-${index}`)?.classList.add('hidden');
        };
      }
    } catch (e) {
      console.warn(`Image ${index} failed:`, e);
    }
  }

  async function generateAllImages(locations) {
    for (let i = 0; i < locations.length; i++) {
      await generateImage(locations[i].imagePrompt, i);
      if (i < locations.length - 1) await new Promise(r => setTimeout(r, 1200));
    }
  }

  // ===== SOUND MANAGER =====
  class SoundManager {
    constructor() {
      this.player = null; this.isPlaying = false; this.isReady = false;
      this.currentOst = null; this.pendingPlay = null;
      const div = document.createElement('div');
      div.id = 'yt-player';
      div.style.cssText = 'position:fixed;bottom:0;left:0;width:1px;height:1px;overflow:hidden;opacity:0;pointer-events:none;';
      document.body.appendChild(div);
    }
    _onReady() {
      this.isReady = true;
      this.player.setVolume(30);
      if (this.pendingPlay) { this._loadVideo(this.pendingPlay.videoId, this.pendingPlay.startSeconds); this.pendingPlay = null; }
    }
    _loadVideo(videoId, startSeconds) {
      if (!this.isReady || !this.player) { this.pendingPlay = { videoId, startSeconds }; return; }
      this.player.loadVideoById({ videoId, startSeconds: startSeconds || 0 });
      this.isPlaying = true;
    }
    async changeMood(ostData) {
      if (!ostData) return;
      this.currentOst = ostData;
      document.getElementById('audioMoodLabel').textContent = `üéµ ${ostData.title || 'OST'}`;
      document.getElementById('audioArtist').textContent = ostData.artist || 'K-Content OST';
      const query   = ostData.searchQuery || `${ostData.title} ${ostData.artist} official`;
      const videoId = await this._searchYouTube(query);
      if (videoId) this._loadVideo(videoId, ostData.startSeconds || 0);
    }
    async _searchYouTube(query) {
      try {
        const res = await fetch(`/api/youtube-search?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        if (data.items?.length > 0) return data.items[0].id.videoId;
      } catch (e) { console.warn('YouTube search failed:', e); }
      return null;
    }
    toggle() {
      if (!this.player || !this.isReady) return this.isPlaying;
      if (this.isPlaying) { this.player.pauseVideo(); this.isPlaying = false; }
      else { this.player.playVideo(); this.isPlaying = true; }
      return this.isPlaying;
    }
    setVolume(v) { if (this.player && this.isReady) this.player.setVolume(v); }
  }

  const soundManager = new SoundManager();

  function onYouTubeIframeAPIReady() {
    soundManager.player = new YT.Player('yt-player', {
      height: '1', width: '1',
      playerVars: { autoplay: 0, controls: 0, disablekb: 1, fs: 0, modestbranding: 1, rel: 0 },
      events: {
        onReady: () => soundManager._onReady(),
        onStateChange: e => { soundManager.isPlaying = e.data === YT.PlayerState.PLAYING; updateAudioUI(soundManager.isPlaying); },
        onError: () => { soundManager.isPlaying = false; updateAudioUI(false); },
      },
    });
  }

  function updateAudioUI(playing) {
    document.getElementById('playIcon').style.display  = playing ? 'none'  : 'block';
    document.getElementById('pauseIcon').style.display = playing ? 'block' : 'none';
  }

  // ===== SCREEN TRANSITIONS =====
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // ===== MAIN SEARCH =====
  async function doSearch(content) {
    // Loading screen
    const preview = document.getElementById('loadPosterPreview');
    preview.style.background = content.bg;
    preview.textContent = content.emoji;
    showScreen('loadingScreen');

    try {
      const data = await getLocations(content.query);

      applyMood(data.mood);
      document.getElementById('resultTitle').textContent = data.contentTitle || content.query;

      showScreen('resultScreen');

      addMarkers(data.locations, data.mood);
      buildCards(data.locations, data.mood);

      try {
        await soundManager.changeMood(data.ost);
        updateAudioUI(true);
      } catch (e) { console.warn('Audio failed:', e); }

      generateAllImages(data.locations);

    } catch (err) {
      console.error(err);
      showScreen('landingScreen');
      const toast = document.getElementById('errorMsg');
      toast.classList.add('active');
      setTimeout(() => toast.classList.remove('active'), 3000);
    }
  }

  // ===== EVENTS =====
  document.getElementById('backBtn').addEventListener('click', () => {
    showScreen('landingScreen');
  });

  document.getElementById('audioPlayBtn').addEventListener('click', () => {
    const playing = soundManager.toggle();
    updateAudioUI(playing);
  });

  document.getElementById('audioVolume').addEventListener('input', e => {
    soundManager.setVolume(parseInt(e.target.value));
  });

  // ===== INIT =====
  buildCoverflow();

  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => {});
</script>

<!-- Load Google Maps (key injected server-side) -->
<script src="/api/maps-script"></script>

</body>
</html>
